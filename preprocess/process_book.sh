#!/bin/bash
#SBATCH --job-name=preprocess-book
#SBATCH --time=0-02:00:00
#SBATCH --nodes=1
#SBATCH --ntasks=20 # number of cores/processors
#SBATCH --mem=50G
#SBATCH --partition=gpu
#SBATCH --gres=gpu:1
#SBATCH --output=/dev/null
#SBATCH --error=/dev/null
#SBATCH -A eng_viva
#SBATCH --mail-type=begin,end
#SBATCH --mail-user=tkg5kq@virginia.edu
#SBATCH -a 407,420,448,582,612,711,815,72,365,393,400,666,130,450,624,115,337,540,672,831,249,404,574,603,773,798,799,61,247,812,329,335,347,776,889,39,41,330,334,813,649,792,667,712,811,399,409,440,306,323,424,780,883,144,320,328,449,709,833,354,585,604,856,18,94,189,371,402,576,665,857,860,97,99,392,464,671,887,42,71,800,817,331,342,471,613,647,803,832,114,353,373,465,581,170,408,573,580,248,594,762,830,403,854,126,423,797,858,77,300,579,810,1,95,401,412,271,447,364,629,267,352,623,724,754,128,305,570,87,105,225,664,882,156,349,76,83,256,411,521,179,398,588,154,178,183,117,169,370,622,633,453,463,589,93,98,163,264,796,886,96,388,174,341,648,127,317,348,677,168,435,509,575,726,304,369,587,827,522,885,192,663,422,489,596,828,46,391,583,38,336,855,134,892,755,829,710,826,173,274,415,578,184,508,555,859,343,410,241,368,390,275,351,632,45,67,104,333,86,172,307,263,92,143,203,469,645,367,405,774,507,593,207,387,66,196,414,297,406,658,418,112,91,161,753,740,53,17,129,385,419,445,669,195,644,85,366,484,133,676,741,82,346,752,162,488,630,818,321,732,824,283,564,89,224,611,16,171,436,444,675,345,194,567,621,277,52,602,15,884,262,282,454,751,160,122,344,539,643,733,88,577,132,386,584,586,861,460,461,572,853,881,791,483,597,608,103,825,327,206,394,610,121,193,670,458,459,563,877,878,177,257,389,569,880,620,819,14,750,159,674,761,789,468,879,852,520,538,601,749,124,609,236,481,65,84,438,778,673,668,519,13,190,779,2,443,642,823,315,646,40,37,230,595,739,269,437,261,350,413,223,790,480,627,229,319,482,641,120,431,650,240,131,788,176,12,202,222,640,554,626,439,102,614,221,725,205,748,340,101,51,81,607,119,479,772,537,553,175,430,474,863,625,255,339,153,204,270,36,747,100,417,771,201,90,421,473,50,518,260,123,787,80,639,851,246,35,228,254,457,606,848,70,125,113,472,180,235,731,158,738,804,847,379,775,566,681,768,74,592,619,69,517,876,11,591,737,786,227,821,746,767,795,220,600,451,276,34,456,326,259,701,723,490,219,809,79,467,299,516,218,760,63,64,157,455,217,298,242,416,875,75,736,766,515,296,562,628,10,118,590,745,757,478,735,73,631,62,363,506,116,188,49,44,272,794,78,765,850,325,514,536,874,442,142,33,511,258,708,462,200,734,362,216,695,9,505,822,487,605,730,48,742,785,234,744,849,32,268,338,266,694,226,215,152,504,441,729,233,214,535,820,141,807,707,68,57,199,700,706,486,60,565,618,213,793,705,693,31,743%100

LOG_DIR="logs"
if [ ! -d "$LOG_DIR" ]; then
    mkdir -p "$LOG_DIR"
fi

if [[ -n "${SLURM_ARRAY_JOB_ID}" ]]; then
    mkdir -p "$LOG_DIR/$SLURM_ARRAY_JOB_ID"
else
    now=$(date +"%y%m%d-%H%M%S")
    mkdir -p "$LOG_DIR/$now"
fi

# configure log file path
# Check if SLURM_ARRAY_JOB_ID is set and not empty
if [[ -n "${SLURM_ARRAY_JOB_ID}" ]]; then
    now=$(date +"%y%m%d")
    logpath="${LOG_DIR}/$SLURM_ARRAY_JOB_ID/logs-$now-${SLURM_ARRAY_JOB_ID}"
    mkdir -p $logpath
    logfile="$logpath/${SLURM_ARRAY_TASK_ID}.out"
else
    # Use the last argument as the log file if SLURM_ARRAY_JOB_ID is not set
    now=$(date +"%y%m%d-%H%M%S")
    logfile="${LOG_DIR}/$now/logs-$now.out"
fi

source /home/tkg5kq/.bashrc > "${logfile}" 2>&1
source activate bound >> "${logfile}" 2>&1

echo "Running $@ with ID ${SLURM_ARRAY_TASK_ID} ..."

python ./preprocess_new_annotations.py book --vid_num ${SLURM_ARRAY_TASK_ID} >> "${logfile}" 2>&1

sleep 45